<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Modules</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <nav class="bg-gray-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">Manage Modules</h1>
                <a href="/admin/dashboard" class="text-gray-300 hover:text-white">Dashboard</a>
            </div>
            <button onclick="AdminApp.logout()" class="text-gray-300 hover:text-white">Logout</button>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="/admin/dashboard"
                class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Dashboard
            </a>
        </div>

        <!-- Add Module Form -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-lg font-bold mb-4">Add New Module</h2>
            <form id="addModuleForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Module Name</label>
                        <input type="text" id="moduleName" required
                            class="mt-1 block w-full rounded-md border border-gray-300 p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="moduleDesc"
                            class="mt-1 block w-full rounded-md border border-gray-300 p-2">
                    </div>
                </div>

                <!-- Config Section -->
                <div class="border-t pt-4 mt-4">
                    <h3 class="text-md font-semibold mb-2">Schedule Configuration</h3>

                    <!-- Days -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Available Days</label>
                        <div class="flex flex-wrap gap-4" id="daysContainer">
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="1">
                                <span class="ml-2">Mon</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="2">
                                <span class="ml-2">Tue</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="3">
                                <span class="ml-2">Wed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="4">
                                <span class="ml-2">Thu</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="5">
                                <span class="ml-2">Fri</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="6">
                                <span class="ml-2">Sat</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600" name="days" value="0">
                                <span class="ml-2">Sun</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sessions -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Sessions</label>
                            <button type="button" onclick="addSessionRow('addSessionContainer')"
                                class="text-sm text-blue-600 hover:text-blue-800">+ Add Session</button>
                        </div>
                        <div id="addSessionContainer" class="space-y-2">
                            <!-- Session Rows will be added here -->
                        </div>
                    </div>
                </div>

                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add
                    Module</button>
            </form>
        </div>

        <!-- Modules List -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="modulesList">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Edit Module Modal -->
    <div id="editModuleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Edit Module</h3>
                <form id="editModuleForm">
                    <input type="hidden" id="editModuleId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Module Name</label>
                        <input type="text" id="editModuleName" required
                            class="mt-1 block w-full rounded-md border border-gray-300 p-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="editModuleDesc"
                            class="mt-1 block w-full rounded-md border border-gray-300 p-2"></textarea>
                    </div>

                    <!-- Edit Config Section -->
                    <div class="border-t pt-4 mt-4 mb-4">
                        <h3 class="text-md font-semibold mb-2">Schedule Configuration</h3>

                        <!-- Days -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Available Days</label>
                            <div class="flex flex-wrap gap-4" id="editDaysContainer">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="1">
                                    <span class="ml-2">Mon</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="2">
                                    <span class="ml-2">Tue</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="3">
                                    <span class="ml-2">Wed</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="4">
                                    <span class="ml-2">Thu</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="5">
                                    <span class="ml-2">Fri</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="6">
                                    <span class="ml-2">Sat</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" class="form-checkbox text-blue-600" name="editDays"
                                        value="0">
                                    <span class="ml-2">Sun</span>
                                </label>
                            </div>
                        </div>

                        <!-- Sessions -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Sessions</label>
                                <button type="button" onclick="addSessionRow('editSessionContainer')"
                                    class="text-sm text-blue-600 hover:text-blue-800">+ Add Session</button>
                            </div>
                            <div id="editSessionContainer" class="space-y-2">
                                <!-- Session Rows will be added here -->
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit"
                            class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            Update
                        </button>
                        <button type="button" onclick="AdminApp.closeEditModuleModal()"
                            class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
        // UI Helper for Session Rows
        function addSessionRow(containerId, data = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center session-row';
            div.innerHTML = `
                <input type="text" placeholder="Session Name" class="session-name flex-1 rounded-md border border-gray-300 p-2 text-sm" value="${data ? data.name : ''}" required>
                <input type="time" class="session-start w-24 rounded-md border border-gray-300 p-2 text-sm" value="${data ? data.start_time : ''}" required>
                <span class="text-gray-500">-</span>
                <input type="time" class="session-end w-24 rounded-md border border-gray-300 p-2 text-sm" value="${data ? data.end_time : ''}" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            `;
            container.appendChild(div);
        }

        // Override AdminApp.initModules to handle new config data
        // We'll intercept the form submissions

        document.addEventListener('DOMContentLoaded', () => {
            AdminApp.checkAuth();
            AdminApp.initModules();

            // Override Add Form Submit
            const addForm = document.getElementById('addModuleForm');
            addForm.onsubmit = async (e) => {
                e.preventDefault();
                const name = document.getElementById('moduleName').value;
                const description = document.getElementById('moduleDesc').value;

                // Collect Config
                const days = Array.from(document.querySelectorAll('#daysContainer input:checked')).map(cb => parseInt(cb.value));
                const sessionRows = document.querySelectorAll('#addSessionContainer .session-row');
                const sessions = Array.from(sessionRows).map(row => ({
                    name: row.querySelector('.session-name').value,
                    start_time: row.querySelector('.session-start').value,
                    end_time: row.querySelector('.session-end').value
                }));

                const usage_config = { days, sessions };

                try {
                    const res = await fetch('/api/admin/modules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, usage_config })
                    });

                    const data = await res.json();

                    if (data.success) {
                        alert('Module added successfully');
                        addForm.reset();
                        document.getElementById('addSessionContainer').innerHTML = ''; // Clear sessions
                        AdminApp.loadModules();
                    } else {
                        alert(data.message || 'Failed to add module');
                    }
                } catch (error) {
                    alert(error.message);
                }
            };

            // Hook into Edit Button clicks (Delegate)
            // Override the editModule function to fetch details first
            const originalEditModule = AdminApp.editModule;
            AdminApp.editModule = async (id, name, description) => {
                try {
                    console.log('Fetching module details for ID:', id); // Debug Log
                    const res = await fetch('/api/public/modules');
                    const json = await res.json();
                    if (json.success) {
                        const module = json.data.find(m => m.id == id);
                        console.log('Module Data Found:', module); // Debug Log
                        if (module) {
                            // Set Basic Fields
                            document.getElementById('editModuleId').value = module.id;
                            document.getElementById('editModuleName').value = module.name;
                            document.getElementById('editModuleDesc').value = module.description || '';

                            // Set Config
                            let config = module.usage_config;
                            console.log('Raw Usage Config:', config, typeof config); // Debug Log

                            // Reset UI
                            document.querySelectorAll('#editDaysContainer input').forEach(cb => cb.checked = false);
                            document.getElementById('editSessionContainer').innerHTML = '';

                            if (config) {
                                // Double check parsing if it's double stringified
                                if (typeof config === 'string') {
                                    try {
                                        config = JSON.parse(config);
                                        // Handle potential double stringify
                                        if (typeof config === 'string') config = JSON.parse(config);
                                    } catch (e) {
                                        console.error('Error parsing config:', e);
                                    }
                                }

                                console.log('Parsed Config:', config); // Debug Log
                                const { days, sessions } = config;

                                if (days) {
                                    days.forEach(d => {
                                        const cb = document.querySelector(`#editDaysContainer input[value="${d}"]`);
                                        if (cb) cb.checked = true;
                                    });
                                }

                                if (sessions) {
                                    sessions.forEach(s => addSessionRow('editSessionContainer', s));
                                }
                            }

                            document.getElementById('editModuleModal').classList.remove('hidden');
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert('Failed to load module details');
                }
            };

            // Override Edit Form Submit
            const editForm = document.getElementById('editModuleForm');
            editForm.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('editModuleId').value;
                const name = document.getElementById('editModuleName').value;
                const description = document.getElementById('editModuleDesc').value;

                // Collect Config
                const days = Array.from(document.querySelectorAll('#editDaysContainer input:checked')).map(cb => parseInt(cb.value));
                const sessionRows = document.querySelectorAll('#editSessionContainer .session-row');
                const sessions = Array.from(sessionRows).map(row => ({
                    name: row.querySelector('.session-name').value,
                    start_time: row.querySelector('.session-start').value,
                    end_time: row.querySelector('.session-end').value
                }));

                const usage_config = { days, sessions };

                try {
                    const res = await fetch(`/api/admin/modules/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, usage_config })
                    });
                    const data = await res.json();

                    if (data.success) {
                        alert('Module updated successfully');
                        AdminApp.closeEditModuleModal();
                        AdminApp.loadModules();
                    } else {
                        alert(data.message || 'Failed to update module');
                    }
                } catch (error) {
                    alert(error.message);
                }
            };
        });
    </script>
</body>

</html>